fs   = require 'fs'
yaml = require 'js-yaml'
lazypipe = require 'lazypipe'
chalk = require 'chalk'
gutil = require 'gulp-util'
cache = require 'gulp-cached'
gulp = {}

loadPipeline = (taskName, taskConfig) ->
  pl = lazypipe()
  pl = pl.pipe gulp.src, taskConfig.src
  pl = pl.pipe cache, taskName if taskConfig.cache

  # Pipeline specific functions
  if taskConfig.pipeline
    for plugin, option of taskConfig.pipeline
      requirement = require "#{process.cwd()}/node_modules/gulp-#{plugin}"
      pl = pl.pipe requirement, option

  pl = pl.pipe gulp.dest, taskConfig.dest
  pl

loadTask = (taskName, taskConfig) ->
  return gulp.task taskName, taskConfig if Array.isArray taskConfig
  return gulp.task taskName, taskConfig.deps, loadPipeline(taskName, taskConfig)

loadYml = (path) ->
  yaml.safeLoad fs.readFileSync path, 'utf8'

module.exports = (gulpInst, tasksPath) ->
  gulp = gulpInst
  dir = tasksPath
  gutil.log 'Plug', chalk.yellow "Importing tasks from #{dir} directory"

  files = fs.readdirSync dir
  for filename in files
    filepath = "#{dir}/#{filename}"

    if /\.yml/.test filename
      taskName = filename.replace '.yml', ''
      taskConfig = loadYml filepath
      loadTask taskName, taskConfig

    if /\.(js|coffee)/.test filename
      require filepath

  gutil.log 'Plug', chalk.yellow "#{files.length} tasks imported"
